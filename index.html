<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small style tweak */
    .card { border-radius: 14px; box-shadow: 0 6px 18px rgba(15,23,42,.06); }
    .btn { transition: transform .12s ease, box-shadow .12s ease; }
    .btn:active { transform: translateY(1px); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<div id="app" class="min-h-screen"></div>

<script>
/* ---------- Storage helpers ---------- */
const STORAGE_USERS = 'emi_users_v1';
const STORAGE_LOGGED = 'emi_logged_v1';

function loadUsers() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_USERS) || '{}');
  } catch (e) { return {}; }
}
function saveUsers(u) { localStorage.setItem(STORAGE_USERS, JSON.stringify(u)); }
function getLogged() { return localStorage.getItem(STORAGE_LOGGED); }
function setLogged(username) { if (username) localStorage.setItem(STORAGE_LOGGED, username); else localStorage.removeItem(STORAGE_LOGGED); }

/* ---------- Utility ---------- */
function q(selector, root=document) { return root.querySelector(selector); }
function qAll(selector, root=document) { return Array.from(root.querySelectorAll(selector)); }
function maskAccount(acc) { if (!acc) return 'â€”'; const s = String(acc); return '****' + s.slice(-4); }
function formatDateISO(d) { if (!d) return 'â€”'; const date = new Date(d); if (isNaN(date)) return 'â€”'; return date.toISOString().slice(0,10); }

/* risk: uses income, emi, salaryDate, dueDate */
function computeRisk(income, emi, salaryDate, dueDate) {
  if (!income || !emi || !salaryDate || !dueDate) return { risk: 'Unknown' };
  const ratio = Number(emi) / Number(income);
  const s = new Date(salaryDate), d = new Date(dueDate);
  const gap = Math.round((d - s) / (1000*60*60*24));
  let risk = 'Low';
  if (ratio > 0.5 || gap < 3) risk = 'High';
  else if (ratio > 0.3) risk = 'Medium';
  return { risk, ratio, gap };
}

/* ---------- App root ---------- */
const app = document.getElementById('app');

/* ---------- Render functions ---------- */

function render() {
  const logged = getLogged();
  if (!logged) {
    renderAuth();
  } else {
    const users = loadUsers();
    const u = users[logged];
    if (!u) { setLogged(null); renderAuth(); return; }
    renderDashboard(u);
  }
}

/* ---------- AUTH (login/signup) ---------- */
function renderAuth() {
  app.innerHTML = `
    <div class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-r from-purple-600 to-pink-500">
      <div class="w-full max-w-xl bg-white p-8 card">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold">EMI Dashboard</h1>
          <div class="text-sm text-gray-500" id="auth-mode-label">Login</div>
        </div>

        <div id="auth-form" class="space-y-3">
          <!-- form inserted by JS -->
        </div>

        <div class="mt-4 text-center">
          <button id="auth-action" class="btn inline-flex items-center gap-2 px-6 py-2 rounded-full bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold">Login</button>
          <div class="mt-3 text-sm text-gray-600">
            <span id="auth-switch-text">New here?</span>
            <button id="switch-auth" class="text-purple-600 underline ml-2">Create account</button>
          </div>
        </div>

        <p class="mt-4 text-xs text-gray-400">Demo: data stays in your browser (localStorage). Passwords are stored locally for demo only.</p>
      </div>
    </div>
  `;

  // default mode: login
  let mode = 'login'; // 'login' or 'signup'
  const authForm = document.getElementById('auth-form');
  const authModeLabel = document.getElementById('auth-mode-label');
  const authAction = document.getElementById('auth-action');
  const switchAuth = document.getElementById('switch-auth');
  const authSwitchText = document.getElementById('auth-switch-text');

  function drawForm() {
    if (mode === 'login') {
      authModeLabel.textContent = 'Login';
      authForm.innerHTML = `
        <input id="login-username" placeholder="Username" class="w-full border p-3 rounded-lg" />
        <input id="login-password" placeholder="Password" type="password" class="w-full border p-3 rounded-lg" />
      `;
      authAction.textContent = 'Login';
      authSwitchText.textContent = 'New here?';
      switchAuth.textContent = 'Create account';
    } else {
      authModeLabel.textContent = 'Create account';
      authForm.innerHTML = `
        <input id="s-username" placeholder="Choose a username" class="w-full border p-3 rounded-lg" />
        <input id="s-name" placeholder="Full name" class="w-full border p-3 rounded-lg" />
        <input id="s-email" placeholder="Email" class="w-full border p-3 rounded-lg" />
        <div class="grid grid-cols-2 gap-2">
          <input id="s-phone" placeholder="Phone (optional)" class="w-full border p-3 rounded-lg" />
          <input id="s-bank" placeholder="Bank name (optional)" class="w-full border p-3 rounded-lg" />
        </div>
        <input id="s-acc" placeholder="Account number (optional)" class="w-full border p-3 rounded-lg" />
        <div class="grid grid-cols-2 gap-2">
          <input id="s-pass" placeholder="Password" type="password" class="w-full border p-3 rounded-lg" />
          <input id="s-confirm" placeholder="Confirm password" type="password" class="w-full border p-3 rounded-lg" />
        </div>
      `;
      authAction.textContent = 'Create account';
      authSwitchText.textContent = 'Already have an account?';
      switchAuth.textContent = 'Login';
    }
  }

  function doLogin() {
    const username = (q('#login-username') || {}).value || '';
    const password = (q('#login-password') || {}).value || '';
    if (!username || !password) { alert('Enter username & password'); return; }
    const users = loadUsers();
    if (!users[username]) { alert('User not found â€” please sign up'); return; }
    if (users[username].password !== password) { alert('Wrong password'); return; }
    setLogged(username);
    render();
  }

  function doSignup() {
    const username = (q('#s-username') || {}).value || '';
    const name = (q('#s-name') || {}).value || '';
    const email = (q('#s-email') || {}).value || '';
    const phone = (q('#s-phone') || {}).value || '';
    const bank = (q('#s-bank') || {}).value || '';
    const acc = (q('#s-acc') || {}).value || '';
    const pass = (q('#s-pass') || {}).value || '';
    const confirm = (q('#s-confirm') || {}).value || '';
    if (!username || !name || !email || !pass || !confirm) { alert('Please fill required fields'); return; }
    if (pass !== confirm) { alert('Passwords do not match'); return; }
    const users = loadUsers();
    if (users[username]) { alert('Username already taken'); return; }
    users[username] = { password: pass, name, email, phone, bankName: bank, accountNumber: acc, emis: [] };
    saveUsers(users);
    setLogged(username);
    render();
  }

  drawForm();

  switchAuth.addEventListener('click', () => {
    mode = (mode === 'login' ? 'signup' : 'login');
    drawForm();
  });

  authAction.addEventListener('click', () => {
    if (mode === 'login') doLogin(); else doSignup();
  });

  // allow Enter key
  authForm.addEventListener('keypress', (ev) => {
    if (ev.key === 'Enter') authAction.click();
  });
}

/* ---------- DASHBOARD ---------- */
function renderDashboard(user) {
  // build page
  app.innerHTML = `
    <div class="min-h-screen flex flex-col">
      <header class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold">Welcome, ${escapeHtml(user.name || user.username)}</h1>
            <p class="text-sm opacity-90">Smart EMI management</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="logoutBtn" class="bg-white/20 px-4 py-2 rounded-lg">Logout</button>
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

          <!-- left / main -->
          <section class="lg:col-span-2 space-y-6">
            <div class="card bg-white p-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h2 class="text-xl font-bold">EMI Risk Predictor</h2>
                  <p class="text-sm text-gray-600">Add EMI details and save to your profile. Risk is computed from income ratio & date gap.</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-gray-700">Monthly Income (â‚¹)</label>
                  <input id="inp-income" type="number" class="w-full border p-3 rounded mt-1" placeholder="Enter monthly income" />
                </div>
                <div>
                  <label class="text-sm text-gray-700">EMI Amount (â‚¹)</label>
                  <input id="inp-emi" type="number" class="w-full border p-3 rounded mt-1" placeholder="Enter EMI amount" />
                </div>
                <div>
                  <label class="text-sm text-gray-700">Salary Date</label>
                  <input id="inp-salary" type="date" class="w-full border p-3 rounded mt-1" />
                </div>
                <div>
                  <label class="text-sm text-gray-700">EMI Due Date</label>
                  <input id="inp-due" type="date" class="w-full border p-3 rounded mt-1" />
                </div>
              </div>

              <div class="mt-4 text-center">
                <button id="btn-add-emi" class="btn bg-gradient-to-r from-purple-600 to-pink-500 text-white px-6 py-3 rounded-full font-semibold">ðŸ”® Predict & Save</button>
              </div>

              <div id="last-pred" class="mt-4 text-center text-gray-700"></div>
            </div>

            <div id="reminders-card" class="card bg-white p-6">
              <h3 class="text-lg font-semibold mb-3">Reminders</h3>
              <div id="reminders-list" class="space-y-3"></div>
            </div>

            <div id="topup-card" class="card bg-white p-6">
              <h3 class="text-lg font-semibold mb-3">Top-Up Suggestions</h3>
              <div id="topup-list" class="space-y-3"></div>
            </div>

          </section>

          <!-- right / sidebar -->
          <aside class="space-y-6">
            <div class="card bg-white p-6">
              <h3 class="font-semibold text-lg mb-3">Profile</h3>
              <p><strong>Name:</strong> ${escapeHtml(user.name || user.username)}</p>
              <p><strong>Email:</strong> ${escapeHtml(user.email || 'â€”')}</p>
              <p><strong>Phone:</strong> ${escapeHtml(user.phone || 'â€”')}</p>

              <hr class="my-3" />

              <h4 class="font-semibold">Bank</h4>
              <p><strong>Bank:</strong> ${escapeHtml(user.bankName || 'â€”')}</p>
              <p><strong>Account:</strong> ${escapeHtml(maskAccount(user.accountNumber))}</p>

              <hr class="my-3" />

              <h4 class="font-semibold">EMI Overview</h4>
              <p id="stat-total">Total EMIs: â€”</p>
              <p id="stat-paid">Paid: â€”</p>
              <p id="stat-remain">Remaining: â€”</p>
              <p id="stat-last-emi">Last EMI Amount: â€”</p>

              <hr class="my-3" />

              <h4 class="font-semibold">Risk Status</h4>
              <p id="stat-risk">Current Risk: â€”</p>
              <p id="stat-next">Next Due Date: â€”</p>
            </div>
          </aside>

        </div>
      </main>
    </div>
  `;

  // wire up logout
  q('#logoutBtn').addEventListener('click', () => {
    setLogged(null);
    render();
  });

  // populate lists & summary
  refreshProfileAndLists(user);

  // add EMI handler
  q('#btn-add-emi').addEventListener('click', () => {
    const income = q('#inp-income').value.trim();
    const emi = q('#inp-emi').value.trim();
    const sDate = q('#inp-salary').value;
    const dDate = q('#inp-due').value;
    if (!income || !emi || !sDate || !dDate) { alert('Please fill all fields'); return; }
    const { risk } = computeRisk(Number(income), Number(emi), sDate, dDate);
    const users = loadUsers();
    const u = users[user.username];
    if (!u.emis) u.emis = [];
    u.emis.unshift({ id: Date.now(), income: Number(income), emi: Number(emi), salaryDate: sDate, dueDate: dDate, paid: false, risk });
    users[user.username] = u;
    saveUsers(users);
    // show last prediction text
    q('#last-pred').textContent = `Last added EMI risk: ${risk}`;
    // clear inputs
    q('#inp-income').value = ''; q('#inp-emi').value = ''; q('#inp-salary').value = ''; q('#inp-due').value = '';
    // refresh UI
    refreshProfileAndLists(u);
  });
}

/* ---------- utilities for dashboard refresh ---------- */
function refreshProfileAndLists(user) {
  const users = loadUsers();
  const u = users[user.username] || user;

  // summary
  const total = (u.emis || []).length;
  const paid = (u.emis || []).filter(x => x.paid).length;
  const remain = total - paid;
  const lastEmi = (u.emis && u.emis[0]) ? u.emis[0].emi : 0;
  const currentRisk = (u.emis && u.emis[0]) ? u.emis[0].risk : 'â€”';
  const nextDue = (() => {
    const unpaid = (u.emis || []).filter(x => !x.paid && x.dueDate).map(x => x.dueDate).sort();
    return unpaid.length ? unpaid[0] : 'â€”';
  })();

  // update sidebar stats
  if (q('#stat-total')) q('#stat-total').textContent = `Total EMIs: ${total}`;
  if (q('#stat-paid')) q('#stat-paid').textContent = `Paid: ${paid}`;
  if (q('#stat-remain')) q('#stat-remain').textContent = `Remaining: ${remain}`;
  if (q('#stat-last-emi')) q('#stat-last-emi').textContent = `Last EMI Amount: â‚¹${lastEmi}`;
  if (q('#stat-risk')) q('#stat-risk').textContent = `Current Risk: ${currentRisk}`;
  if (q('#stat-next')) q('#stat-next').textContent = `Next Due Date: ${nextDue}`;

  // reminders list
  const remList = q('#reminders-list');
  if (remList) {
    remList.innerHTML = '';
    const emis = u.emis || [];
    if (!emis.length) {
      remList.innerHTML = '<p class="text-gray-500">No EMIs added yet. Add one from the form above.</p>';
    } else {
      emis.forEach(e => {
        const wrap = document.createElement('div');
        wrap.className = 'p-3 border rounded flex items-start justify-between bg-white';
        wrap.innerHTML = `
          <div>
            <div class="text-sm"><strong>â‚¹${e.emi}</strong> â€¢ ${escapeHtml(e.risk)} risk</div>
            <div class="text-xs text-gray-500">Due: ${escapeHtml(e.dueDate)} â€¢ Salary: ${escapeHtml(e.salaryDate)}</div>
            <div class="text-xs mt-1">Status: ${e.paid ? '<span class="text-green-600">Paid</span>' : '<span class="text-red-600">Unpaid</span>'}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button data-action="toggle" data-id="${e.id}" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 text-sm">${e.paid ? 'Mark unpaid' : 'Mark paid'}</button>
            <button data-action="del" data-id="${e.id}" class="px-3 py-1 rounded bg-red-50 text-red-600 text-sm">Delete</button>
          </div>
        `;
        remList.appendChild(wrap);
      });
    }
    // attach listeners
    remList.querySelectorAll('[data-action="toggle"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        togglePaid(user.username, id);
      });
    });
    remList.querySelectorAll('[data-action="del"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.dataset.id);
        deleteEntry(user.username, id);
      });
    });
  }

  // top-up suggestions (High risk unpaid)
  const topList = q('#topup-list');
  if (topList) {
    topList.innerHTML = '';
    const suggestions = (u.emis || []).filter(e => !e.paid && e.risk === 'High');
    if (!suggestions.length) {
      topList.innerHTML = '<p class="text-gray-500">No top-up suggestions for now.</p>';
    } else {
      suggestions.forEach(s => {
        const node = document.createElement('div');
        node.className = 'p-3 border rounded bg-white';
        const suggested = Math.round(s.emi * 0.3);
        node.innerHTML = `<div>EMI â‚¹${s.emi} due ${escapeHtml(s.dueDate)}</div><div class="text-sm text-gray-600">Suggested top-up: <strong>â‚¹${suggested}</strong></div>`;
        topList.appendChild(node);
      });
    }
  }
}

/* ---------- actions ---------- */
function togglePaid(username, id) {
  const users = loadUsers();
  const u = users[username];
  if (!u) return;
  u.emis = u.emis.map(e => e.id === id ? {...e, paid: !e.paid} : e);
  users[username] = u;
  saveUsers(users);
  render(); // re-render whole view to keep things simple
}
function deleteEntry(username, id) {
  if (!confirm('Delete this EMI entry?')) return;
  const users = loadUsers();
  const u = users[username];
  if (!u) return;
  u.emis = u.emis.filter(e => e.id !== id);
  users[username] = u;
  saveUsers(users);
  render();
}

/* ---------- small safety / escaping ---------- */
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ---------- initial render ---------- */
render();

</script>
</body>
</html>
